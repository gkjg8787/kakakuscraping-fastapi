{% extends "layout.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}" type="text/css">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/selectitem.css') }}" type="text/css">
    <title>価格計算の対象アイテムの選択</title>
{% endblock %}

{% block body %}
    <script type="text/javascript">
        const checkMax = Number('{{ ITEM_LIMIT }}');
        const checkBoxes = document.getElementsByName('{{ ITEMID_Q_NAME }}');
        let checkcountview = document.getElementsByClassName('select_item_count')

        function checkCount(target) {
            let checkCount = 0;
            checkBoxes.forEach(checkBox => {
                if (checkBox.checked) {
                checkCount++;
                }
            });
            if (checkCount > checkMax) {
                alert(`最大${checkMax}つまで`);
                target.checked = false;
                checkCount--;
            }
            checkcountview[0].innerText = `${checkCount}/${checkMax}`
        }

        
        window.onload = function () {
            checkBoxes.forEach(checkBox => {
                checkBox.addEventListener('change', () => {
                    checkCount(checkBox);
                })
            });
        }
    </script>
    <h1>価格計算の対象アイテムの選択</h1>
    <p>
        選択したアイテムから最適な店での購入の組み合わせを作成します。
        合わせ買いをしたいアイテムを選択して下さい。選択は{{ ITEM_LIMIT }}つまで。
    </p>
    <div>
        注意：組み合わせの全数チェックは行っていないため、正確ではない場合があります。
    </div>
    {%- if errmsg %}
        <p>{{ errmsg }}</p>
    {%- endif %}
    <p><a href="{{ url_for('read_users') }}" class="plain-link">戻る</a></p>
    <h2>アイテム一覧</h2>
    <h3>フィルタ</h3>
    <p>
    {%- with GROUPID_NAME = GROUPID_NAME, groups = groups, fquery = fquery %}
    {%- include "users/item_group_filter.html" %}
    {%- endwith %}
    </p>
    <p>
    {%- with ITEMACT_NAME = ITEMACT_NAME, actstslist = actstslist, fquery = fquery %}
    {%- include "users/item_act_filter.html" %}
    {%- endwith %}
    </p>
    <p>
    {%- with STOCK_NAME = STOCK_NAME, STOCK_VALUE = STOCK_VALUE, ZAIKO_CHECKED = ZAIKO_CHECKED, fquery = fquery %}
    {%- include "users/item_in_stock_filter.html" %}
    {%- endwith %}
    </p>
    <p>
    {%- with ITEMSORT_NAME = ITEMSORT_NAME, itemSortList = itemSortList, fquery = fquery %}
    {%- include "users/item_sort_filter.html" %}
    {%- endwith %}
    </p>
    <p>
    {%- with EQST_NAME = EQST_NAME, storelist = storelist, fquery = fquery %}
    {%- include "users/item_store_filter.html" %}
    {%- endwith %}
    </p>
    <div class="select_item_count">0/{{ ITEM_LIMIT }}</div>
    <form method="get" action="{{ url_for('read_input_shop_shipping_condition') }}">
        <table class='recent_table'>
        <tr>
            <th>選択</th>
            <th>item_id</th>
            <th>商品名</th>
            <th>URL</th>
            <th>直近価格</th>
            <th>店名</th>
            <th>更新時間</th>
            <th>今までの最安値</th>
            <th>活性数</th>
        </tr>
        {%- for row in res %}
            <tr id="item{{ row['item_id'] }}">
            <td><input type="checkbox" name="{{ ITEMID_Q_NAME }}" value="{{ row['item_id'] }}"></td>
            <td>{{ row['item_id'] }}</td>
            <td>{{ row['name'] }}</td>
            <td>{{ row['urlpath'] }}</td>
            <td>{{ row['price'] }}円</td>
            <td>{{ row['storename'] }}</td>
            <td>{{ row['created_at'] }}</td>
            <td>{{ row['lowestprice'] }}円</td>
            <td>{{ row['act'] }}</td>
        {%- endfor %}
        </table>
        {%- if res %}
        <button type="submit">次へ</button>
        {%- endif %}
    </form>
    <p><a href="{{ url_for('read_users') }}" class="plain-link">戻る</a></p>
{% endblock %}
